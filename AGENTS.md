# AI 协作开发约定（AI Development Contract）

> 本文档用于**约束与指导 AI 参与代码编写时的完整协作流程**，确保代码质量、可维护性与团队协作一致性。
>
> **适用对象**：所有参与本仓库开发的 AI Agent（含 Copilot 类、CLI Agent、自动化 Agent）。

---

## 1. 总体原则（必须遵守）

1. **AI 是协作开发者，而不是直接提交者**
2. **AI 必须遵循与人类开发者一致的工程规范**
3. **所有 AI 行为必须可追溯、可审查、可复现**

---

## 2. 开发前置约定（Before Coding）

### 2.1 必须读取仓库约定文档

在开展任何工作之前，AI **必须先阅读并理解** 以下内容（如存在）：

* `README.md`
* `AGENTS.md`
* `architecture.md` - 总体架构设计
* `requirements.md` - 功能需求规范
* 开发规范，如 `docs/开发规范/`

> ❗ 禁止在**未读取仓库约定**的情况下直接开始写代码。

---

### 2.2 必须基于分支开展工作

* 所有开发必须通过功能分支进行，**不区分 AI 或人类**
* 禁止在 `main` / `master` / `release` 等受保护分支上直接修改代码
* 分支命名仅描述变更类型，不体现身份，例如：

```text
feature/xxx   # 新功能或改进
fix/xxx       # 缺陷修复
refactor/xxx  # 重构优化
chore/xxx     # 工程性调整
```

* 所有代码修改 **仅允许发生在对应分支下**

---

### 2.3 必须基于 Worktree 开展工作（AI 强制）

* AI 必须为任务创建独立 `worktree`，不得在主目录操作

```bash
repo_name=$(basename "$(git rev-parse --show-toplevel)")
mkdir -p ../ai-worktrees/${repo_name}
git worktree add ../ai-worktrees/${repo_name}/<task-name> <branch>
cd ../ai-worktrees/${repo_name}/<task-name>
```

* 进入后必须先执行环境初始化：

```bash
make setup
make build
```

* 所有修改仅允许发生在 `../ai-worktrees/${repo_name}/<task-name>/` 内

* 任务完成后，运行下面的命令进行编译测试，如果有错误，请修改。
```bash
make build
make test 
```

* 任务完成后要提醒人类进行分支合并操作。合并完成后，删除该 worktree

```bash
git worktree remove ../ai-worktrees/${repo_name}/<task-name>
git worktree prune
```

---

### 2.4 写代码前必须先写文档

在编写任何代码之前，AI **必须先编写设计 / 说明文档**，用于明确：

* 要解决的问题
* 功能目标与边界
* 核心设计思路
* 可能影响的模块
* 修改文档必须填写《变更记录表》，如果没有这个章节，必须在文件头部增加《变更记录表》章节

#### 文档存放规则（强制）

* 文档 **必须放在约定的文档目录中**，例如：
  * `docs/design/` - 设计文档
  * `docs/requirements/` - 需求文档
  * `docs/bugs/` - 缺陷文档
* 已有相关文档的情况下，必须将更新内容，增加到原来的文档中

请遵循 `docs/文档编写规范/README.md` 中的约定。

* ❌ 不得随意将文档放在根目录或代码目录

---

## 3. 编码约定（During Coding）

### 3.1 注释与可读性要求

* **禁止随意删除已有注释**
* 如确需删除或调整注释，必须显式标记，例如：

```text
// 原注释内容（删除，待确认）
```

* **关键业务逻辑必须有详细注释**，包括但不限于：

  * 核心流程
  * 关键判断条件
  * 安全相关逻辑
  * 状态变更逻辑

> 目标：即使 AI 不在场，人类也能理解代码为什么这么写。

---

### 3.2 API 与接口一致性

* 在编写涉及接口调用或接口实现的代码时：

  * 必须检查是否存在对应的 API 文档
  * 严格遵循接口定义（字段、语义、错误码）

* ❌ 禁止在未同步更新文档的情况下"擅自扩展或修改接口行为"

---

### 3.3 日志输出要求

使用标准 Go 日志库（如 `log` 或 `zap`）输出详细日志，用于调试和问题排查。

* 使用适当的日志级别（Debug、Info、Warn、Error）
* 日志内容应包含上下文信息，便于问题定位

---

### 3.4 错误处理要求

* 遵循 Go 标准错误处理模式
* 错误信息必须清晰、可读
* 对于需要向用户展示的错误，应转换为友好的提示信息
* 关键路径的错误必须有适当的日志记录

---

## 4. 完成后的强制检查（After Coding）

### 4.1 编译与测试

代码完成后，AI **必须执行并确认**：

* 项目可正常编译 / 构建
* 已有单元测试可通过
* 新增功能应补充必要的单元测试（如仓库已有测试体系）

```bash
make build
make test
make dev #运行
```

---

### 4.2 代码测试（必须）

AI 在完成代码后，**必须对所写代码进行一次测试**，包括但不限于：

按照 `docs/测试规范/` 中的约定进行测试。

---

### 4.3 安全扫描与安全反思（必须）

AI 在完成代码后，**必须对所写代码进行一次安全自检**，包括但不限于：

* 是否存在：

  * 明显的逻辑漏洞
  * 越权访问风险
  * 输入未校验问题
  * 敏感信息泄露风险
* 是否引入了：

  * 不必要的高权限操作
  * 不安全的默认配置

> 若无法自动扫描，必须以**文字形式进行安全反思说明**。

---

## 5. 功能总结与需求对应

### 5.1 功能总结文档（强制）

每一个功能开发完成后，AI **必须撰写功能总结文档**，内容包括：

* 实现了什么
* 与需求的对应关系
* 关键实现点
* 已知限制或待改进点
* 实现总结必须能明确对应到原始需求文档

### 5.2 存放规则

请遵循 `docs/文档编写规范/README.md` 中的约定。

---

## 6. 缺陷处理

### 6.1 缺陷修复说明文档（强制）

每个缺陷都必须记录在缺陷目录中，目录结构如下：

```text
docs/bugs/
  001-仓库分支无法创建/
    001-仓库分支无法创建-缺陷说明.md
    001-仓库分支无法创建-缺陷分析.md
    001-仓库分支无法创建-修复总结.md
```

* 缺陷说明文档
* 缺陷分析文档
* 修复总结文档

### 6.2 存放规则

请遵循 `docs/文档编写规范/Bug缺陷处理文档编写规范.md` 中的约定。

---

## 7. 提交与审核说明

* ❌ **AI 不得自行决定代码是否合并**
* 当前约定：

  * AI 负责编码与说明
  * 人工负责最终审核与提交

> 注：
>
> * "AI 写完代码后不要直接 commit，需要等待人工审核和提交"
> * **该规则当前已废弃，不再作为强制约束**
> * 但 AI 仍应以"等待人工确认"为默认心智模型

---

## 8. 违约处理原则（给 AI 的底线）

若发现以下情况，AI 应立即停止继续编码，并提示人类介入：

* 无法确认仓库规范
* 文档目录或需求目录不清晰
* 接口定义存在冲突或歧义
* 关键安全逻辑不明确

---

## 9. 目标总结

> 这份约定的目标不是限制 AI，而是：

* 让 AI 像一个**成熟、可协作的工程师**一样工作
* 让 AI 的产出 **可维护、可审计、可持续演进**
* 降低 AI 引入后的工程风险，而不是制造新的不确定性

---

**AI 必须默认遵守本约定，除非人类明确声明例外。**