# 项目分层

本文档定义项目的目录结构和各层职责。

## 目录结构

```text
cmd/
  controlplane/  // 控制平面启动入口
  adapter/       // 适配器启动入口（如需要）
internal/
  api/           // API 路由和 Handler
  service/       // 业务服务层
  domain/        // 领域模型（纯数据 + 规则）
  repository/    // 数据访问层
  model/         // 数据库模型
  middleware/    // 中间件
  pkg/           // 通用工具
config/         // 配置管理
```

## 分层职责

### API / Handler 层

**职责**：处理 HTTP 请求和响应

- 路由注册
- 参数绑定和校验
- 调用 Service
- 错误转换
- 返回统一 Response

**禁止**：
- 写业务逻辑
- 操作数据库
- 开启事务

### Service 层

**职责**：业务逻辑编排

- 业务规则校验
- 多 Repository 协调
- 事务控制
- 领域对象转换
- 外部系统调用（如 K8S API）

**禁止**：
- 直接操作数据库
- 返回 Model
- 处理 HTTP 协议细节

### Repository 层

**职责**：数据持久化

- CRUD 操作
- 数据查询
- Model 与 Domain 转换

### Domain 层

**职责**：业务概念定义

- 领域实体
- 值对象
- 业务规则

**禁止**：
- 依赖任何框架
- 依赖数据库
- 包含数据持久化 tag

### Model 层

**职责**：数据库映射

- 表结构定义
- ORM tag

**禁止**：
- 写业务方法
- 被 Service 直接使用

## 分层依赖规则

```
API/Handler → Service → Repository → Model
                   ↓
                Domain
```

### 允许的依赖

| 层          | 可依赖                  |
| ----------- | ----------------------- |
| API/Handler | Service, Domain, DTO    |
| Service     | Repository, Domain, DTO |
| Repository  | Model, Domain           |
| Domain      | 无                      |
| Model       | 无                      |

### 禁止的依赖

| 层          | 禁止依赖                |
| ----------- | ----------------------- |
| API/Handler | Repository, Model, ORM  |
| Service     | 直接操作数据库, Model   |
| Repository  | API/Handler, Service    |
| Domain      | 所有框架                |

## 硬性规则

```
违反分层 = 错误实现
```

每一层只能做自己该做的事，跨层调用是严重错误。

## 相关文档

- [总体原则](./01-总体原则.md)
- [错误处理规范](./05-错误处理规范.md)
- [禁止清单](./15-禁止清单.md)