# 错误处理规范

本文档定义错误处理的方式和规范。

## 核心原则

1. **错误必须可分类**
2. **错误必须被处理**
3. **错误必须可追溯**

## 错误定义方式

### 方式一：标准错误变量

```go
package service

import "errors"

var (
    ErrInstanceNotFound      = errors.New("instance not found")
    ErrInstanceAlreadyExists = errors.New("instance already exists")
    ErrInvalidConfig         = errors.New("invalid config")
    ErrPermissionDenied      = errors.New("permission denied")
)
```

### 方式二：业务错误类型

```go
package errors

type BizError struct {
    Code    string // 错误码
    Message string // 错误消息
}

func (e *BizError) Error() string {
    return e.Message
}

// 预定义业务错误
var (
    ErrInstanceNotFound = &BizError{
        Code:    "INSTANCE_NOT_FOUND",
        Message: "instance not found",
    }
    ErrInstanceAlreadyExists = &BizError{
        Code:    "INSTANCE_ALREADY_EXISTS",
        Message: "instance already exists",
    }
)
```

## 错误包装

使用 `fmt.Errorf` 和 `%w` 包装错误：

```go
func (s *instanceService) Create(ctx context.Context, req CreateInstanceRequest) (*Instance, error) {
    instance, err := s.instanceRepo.Create(ctx, instance)
    if err != nil {
        return nil, fmt.Errorf("failed to create instance: %w", err)
    }
    return instance, nil
}
```

## 错误判断

使用 `errors.Is` 和 `errors.As`：

```go
// 判断错误类型
if errors.Is(err, ErrInstanceNotFound) {
    return nil, ErrInstanceNotFound
}

// 提取错误信息
var bizErr *BizError
if errors.As(err, &bizErr) {
    // 处理业务错误
}
```

## Repository 层错误

```go
package repository

import "errors"

var (
    ErrNotFound     = errors.New("record not found")
    ErrDuplicateKey = errors.New("duplicate key")
)

func (r *instanceRepository) GetByID(ctx context.Context, id string) (*domain.Instance, error) {
    var model InstanceModel
    err := r.db.WithContext(ctx).Where("id = ?", id).First(&model).Error

    if errors.Is(err, gorm.ErrRecordNotFound) {
        return nil, ErrNotFound  // 转换为 repository 错误
    }
    if err != nil {
        return nil, fmt.Errorf("failed to get instance: %w", err)
    }

    return toDomain(&model), nil
}
```

## API 层错误转换

```go
package response

func FromError(c *gin.Context, err error) {
    // 业务错误
    var bizErr *BizError
    if errors.As(err, &bizErr) {
        c.JSON(http.StatusBadRequest, Response{
            Code:    bizErr.Code,
            Message: bizErr.Message,
        })
        return
    }

    // 已知错误
    switch {
    case errors.Is(err, ErrInstanceNotFound):
        NotFound(c, err)
    case errors.Is(err, ErrInstanceAlreadyExists):
        Conflict(c, err)
    case errors.Is(err, ErrPermissionDenied):
        Forbidden(c, err)
    default:
        InternalError(c, err)
    }
}
```

## 禁止事项

```go
// ❌ 直接返回未分类的错误
func (s *instanceService) Create(ctx context.Context, req CreateInstanceRequest) (*Instance, error) {
    return nil, fmt.Errorf("something went wrong")  // 禁止！
}

// ❌ 吞掉错误
func (s *instanceService) Create(ctx context.Context, req CreateInstanceRequest) (*Instance, error) {
    instance, _ := s.instanceRepo.Create(ctx, instance)  // 禁止！
    return instance, nil
}

// ❌ panic 替代错误返回
func (s *instanceService) Create(ctx context.Context, req CreateInstanceRequest) *Instance {
    instance, err := s.instanceRepo.Create(ctx, instance)
    if err != nil {
        panic(err)  // 禁止！
    }
    return instance
}

// ❌ 在错误中包含敏感信息
return nil, fmt.Errorf("api key %s is invalid", apiKey)  // 禁止！
```

## 错误日志

```go
func (s *instanceService) Create(ctx context.Context, req CreateInstanceRequest) (*Instance, error) {
    instance, err := s.instanceRepo.Create(ctx, instance)
    if err != nil {
        log.Error("failed to create instance", "error", err, "instance_id", req.ID)
        return nil, fmt.Errorf("failed to create instance: %w", err)
    }
    return instance, nil
}
```

## 相关文档

- [项目分层](./02-项目分层.md)
- [禁止清单](./15-禁止清单.md)