# 禁止清单

本文档列出 AI 在生成代码时必须遵守的禁止事项。

## 严格禁止

### 1. 在 API / Service 中直接操作数据库

```go
// ❌ 禁止
func (h *InstanceHandler) Create(c *gin.Context) {
    h.db.Create(&instance)  // 禁止！
}

func (s *instanceService) Create(ctx context.Context, req Request) error {
    s.db.Create(&model)  // 禁止！
}

// ✅ 正确
func (s *instanceService) Create(ctx context.Context, req Request) error {
    return s.instanceRepo.Create(ctx, instance)  // 通过 Repository
}
```

### 2. 运行时自动迁移数据库

```go
// ❌ 禁止
func (r *instanceRepository) Create(ctx context.Context, instance *domain.Instance) error {
    r.db.AutoMigrate(&model.InstanceModel{})  // 禁止！
    return r.db.Create(toModel(instance)).Error
}

// ✅ 正确：仅在初始化脚本中迁移
func Migrate(db *gorm.DB) error {
    return db.AutoMigrate(&model.InstanceModel{})
}
```

### 3. 跨层调用

```go
// ❌ 禁止：API/Handler 直接调用 Repository
func (h *InstanceHandler) Create(c *gin.Context) {
    h.instanceRepo.Create(ctx, instance)  // 禁止！
}

// ❌ 禁止：Repository 依赖 Service
type instanceRepository struct {
    svc InstanceService  // 禁止！
}

// ✅ 正确的依赖方向
API/Handler → Service → Repository
```

### 4. 隐式全局状态

```go
// ❌ 禁止
var globalDB *gorm.DB
var globalConfig *Config

func GetInstance(id string) *Instance {
    return globalDB.First(&Instance{}, id)  // 禁止！
}

// ✅ 正确：显式依赖注入
type instanceRepository struct {
    db *gorm.DB
}

func NewInstanceRepository(db *gorm.DB) InstanceRepository {
    return &instanceRepository{db: db}
}
```

### 5. 未分类的错误

```go
// ❌ 禁止
func (s *instanceService) Create(ctx context.Context, req Request) error {
    return fmt.Errorf("failed to create instance")  // 禁止！无法分类
}

// ❌ 禁止
func (s *instanceService) Create(ctx context.Context, req Request) error {
    return errors.New("error")  // 禁止！无意义
}

// ✅ 正确
var ErrInstanceAlreadyExists = errors.New("instance already exists")

func (s *instanceService) Create(ctx context.Context, req Request) error {
    return ErrInstanceAlreadyExists  // 可分类的错误
}
```

### 6. 吞掉错误

```go
// ❌ 禁止
func (s *instanceService) Create(ctx context.Context, req Request) (*Instance, error) {
    instance, _ := s.instanceRepo.Create(ctx, instance)  // 禁止！忽略错误
    return toInstanceDTO(instance), nil
}

// ✅ 正确
func (s *instanceService) Create(ctx context.Context, req Request) (*Instance, error) {
    if err := s.instanceRepo.Create(ctx, instance); err != nil {
        return nil, fmt.Errorf("failed to create instance: %w", err)
    }
    return toInstanceDTO(instance), nil
}
```

### 7. Repository 中控制事务

```go
// ❌ 禁止
func (r *instanceRepository) Create(ctx context.Context, instance *domain.Instance) error {
    tx := r.db.Begin()  // 禁止！
    defer tx.Rollback()
    // ...
    return tx.Commit().Error
}

// ✅ 正确：事务在 Service 层控制
func (s *instanceService) Create(ctx context.Context, req Request) error {
    return s.txMgr.WithTx(ctx, func(tx *gorm.DB) error {
        return s.instanceRepo.CreateWithTx(tx, instance)
    })
}
```

### 8. 混用数据结构

```go
// ❌ 禁止
type Instance struct {
    ID    string `json:"id" gorm:"primaryKey" binding:"required"`
}

// ✅ 正确：分开定义
// Request
type CreateInstanceRequest struct {
    Name  string `json:"name" binding:"required"`
    Type  string `json:"type" binding:"required"`
}

// Domain
type Instance struct {
    ID    string
    Name  string
    Type  string
}

// Model
type InstanceModel struct {
    ID    string `gorm:"primaryKey"`
    Name  string `gorm:"uniqueIndex"`
    Type  string
}
```

### 9. Service 依赖 Gin

```go
// ❌ 禁止
func (s *instanceService) Create(c *gin.Context, req Request) error {
    // 禁止传入 gin.Context
}

// ✅ 正确
func (s *instanceService) Create(ctx context.Context, req Request) error {
    // 使用标准 context.Context
}
```

### 10. API/Handler 写业务逻辑

```go
// ❌ 禁止
func (h *InstanceHandler) Create(c *gin.Context) {
    if len(req.Name) < 3 {
        response.BadRequest(c, errors.New("name too short"))  // 业务逻辑应在 Service
        return
    }
}

// ✅ 正确：业务逻辑在 Service
func (s *instanceService) Create(ctx context.Context, req Request) error {
    if len(req.Name) < 3 {
        return ErrNameTooShort
    }
}
```

### 11. 不使用 WithContext

```go
// ❌ 禁止
func (r *instanceRepository) GetByID(ctx context.Context, id string) (*domain.Instance, error) {
    r.db.Where("id = ?", id).First(&m)  // 禁止！缺少 WithContext
}

// ✅ 正确
func (r *instanceRepository) GetByID(ctx context.Context, id string) (*domain.Instance, error) {
    r.db.WithContext(ctx).Where("id = ?", id).First(&m)
}
```

### 12. 返回 Model 给上层

```go
// ❌ 禁止
func (s *instanceService) GetByID(ctx context.Context, id string) (*model.InstanceModel, error) {
    // 禁止返回 Model
}

// ✅ 正确
func (s *instanceService) GetByID(ctx context.Context, id string) (*InstanceDTO, error) {
    // 返回 DTO
}
```

## 检查清单

在生成代码前，确保：

- [ ] 数据库操作只在 Repository 中
- [ ] 没有运行时 AutoMigrate
- [ ] 依赖方向正确（API/Handler → Service → Repository）
- [ ] 没有全局变量
- [ ] 错误都有明确类型
- [ ] 错误都被处理
- [ ] 事务在 Service 层控制
- [ ] Request / DTO / Model 分开定义
- [ ] Service 不依赖 Gin
- [ ] API/Handler 只做 5 件事
- [ ] 所有数据库操作使用 WithContext
- [ ] Service 返回 DTO，不返回 Model

## 相关文档

- [总体原则](./01-总体原则.md)
- [项目分层](./02-项目分层.md)
- [错误处理规范](./05-错误处理规范.md)