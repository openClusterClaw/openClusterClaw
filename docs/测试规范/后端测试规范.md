# 后端测试规范

> 本规范用于指导 **AI 与开发人员** 在 Go 后端项目中进行一致、可验证、可自动化的开发与测试工作。
>
> **核心目标**：任何新增或修改的功能，都必须具备可自动执行的测试，确保代码质量可控、可回归。

---

## 一、总体原则

1. **先设计接口，再写实现，最后写测试**（AI 也必须遵守）
2. **新增功能 = 代码 + 测试**，禁止只提交实现不提交测试
3. 测试必须：

   * 可自动执行
   * 不依赖真实外部系统
   * 可在本地和 CI 中运行
4. 所有测试必须通过以下命令：

```bash
go test ./...
```

---

## 二、测试分层策略

```
API / Handler Test   → 测接口输入输出
Service Test         → 测业务逻辑（核心规则）
```

### 明确不做

* ❌ 不做端到端 E2E 测试
* ❌ 不测试框架行为（除非是自定义组件）
* ❌ 不在 Service 层直接连接真实数据库

---

## 三、项目目录与文件规范（强制）

```text
internal/
├── api/                  # HTTP Handler
│   ├── xxx.go
│   └── xxx_test.go       # 接口测试
├── service/              # 业务逻辑
│   ├── xxx_service.go
│   └── xxx_service_test.go
├── repository/           # 数据访问层
│   ├── xxx_repo.go
│   └── xxx_repo_test.go
├── domain/               # 领域模型
├── model/                # 数据库模型
└── test/                 # 测试辅助
    ├── fixtures/         # 测试数据
    └── helpers/          # 通用测试工具
```

### 强制规则

* 测试文件必须与被测文件 **同目录**
* 测试文件名必须为 `*_test.go`
* 不允许把测试集中写到单独的 test 包中

---

## 四、Service 层开发与测试规范

### 4.1 Service 设计规范

* Service **必须依赖接口**
* 禁止 Service 直接依赖数据库实现

```go
type InstanceRepository interface {
    GetByID(ctx context.Context, id string) (*domain.Instance, error)
    Create(ctx context.Context, instance *domain.Instance) error
}
```

### 4.2 Service 测试规范

* 使用 Mock / Fake Repository
* 覆盖：

  * 正常路径
  * 错误路径

```go
func TestInstanceService_GetInstance(t *testing.T) {
    repo := &MockInstanceRepository{
        GetByIDFunc: func(ctx context.Context, id string) (*domain.Instance, error) {
            return &domain.Instance{ID: id, Name: "test-instance"}, nil
        },
    }

    svc := NewInstanceService(repo)

    instance, err := svc.GetInstance(context.Background(), "instance-1")

    assert.NoError(t, err)
    assert.Equal(t, "test-instance", instance.Name)
}
```

### 强制要求

> **只要新增或修改 Service 方法，必须同步新增或修改测试**

---

## 五、API / Handler 层测试规范

### 测试目标

* HTTP 状态码
* 返回 JSON 结构
* 错误分支

### 示例

```go
func TestGetInstanceAPI(t *testing.T) {
    r := setupRouter()
    r.GET("/api/v1/instances/:id", mockHandler.GetInstance)

    req := httptest.NewRequest("GET", "/api/v1/instances/instance-1", nil)
    w := httptest.NewRecorder()

    r.ServeHTTP(w, req)

    assert.Equal(t, 200, w.Code)
    assert.Contains(t, w.Body.String(), "\"name\":\"test-instance\"")
}
```

### 不测试内容

* 路由机制（除非是自定义路由）
* 中间件（除非是自定义中间件）

---

## 六、Repository 层与数据库测试规范

### 原则

* Repository 测试 **仅使用 sqlite in-memory**
* 禁止连接真实数据库

```go
db, _ := sql.Open("sqlite", ":memory:")
```

### 使用范围

* 仅限 `*_repo_test.go`
* Service 测试禁止直接使用 DB

---

## 七、AI 编码强制约定（必须遵守）

AI 在生成或修改后端代码时，必须遵循以下规则：

1. 每一个新增接口或业务方法，**必须同时生成对应测试**
2. 不允许：

   * 只生成实现代码
   * 生成无法通过的测试
3. Service 层必须可 Mock
4. Handler 层必须有 HTTP 测试
5. 所有代码提交前，测试必须通过：

```bash
go test ./...
```

---

## 八、CI 执行规范（最低要求）

```yaml
- name: Run tests
  run: |
    go test ./... -race -cover
```

### 合并门禁

* 测试失败 → 禁止合并
* 新功能无测试 → 禁止合并

---

## 九、验收标准

* 新增功能具备对应测试
* 可一键执行全部测试
* 测试不依赖外部系统
* CI 自动校验通过

---

> 本规范作为 **AI 与后端开发的强制约束文档**，必须在开发前被 AI 阅读并遵守。